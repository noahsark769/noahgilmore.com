<!DOCTYPE html><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link rel="stylesheet" href="https://meyerweb.com/eric/tools/css/reset/reset.css"/><style data-href="/styles.a4a03032f8a85ba46eb0.css">/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{line-height:1.15;-webkit-text-size-adjust:100%}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden],template{display:none}blockquote,dd,dl,figure,h1,h2,h3,h4,h5,h6,hr,p,pre{margin:0}button{background-color:transparent;background-image:none}button:focus{outline:1px dotted;outline:5px auto -webkit-focus-ring-color}fieldset,ol,ul{margin:0;padding:0}ol,ul{list-style:none}html{font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica Neue,Arial,Noto Sans,sans-serif,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol,Noto Color Emoji;line-height:1.5}*,:after,:before{box-sizing:border-box;border:0 solid #e2e8f0}hr{border-top-width:1px}img{border-style:solid}textarea{resize:vertical}input::placeholder,textarea::placeholder{color:#a0aec0}[role=button],button{cursor:pointer}table{border-collapse:collapse}h1,h2,h3,h4,h5,h6{font-size:inherit;font-weight:inherit}a{color:inherit;text-decoration:inherit}button,input,optgroup,select,textarea{padding:0;line-height:inherit;color:inherit}code,kbd,pre,samp{font-family:Menlo,Monaco,Consolas,Liberation Mono,Courier New,monospace}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}.container{width:100%}@media (min-width:640px){.container{max-width:640px}}@media (min-width:768px){.container{max-width:768px}}@media (min-width:1024px){.container{max-width:1024px}}@media (min-width:1280px){.container{max-width:1280px}}.border-white{--border-opacity:1;border-color:#fff;border-color:rgba(255,255,255,var(--border-opacity))}.rounded-full{border-radius:9999px}.border-solid{border-style:solid}.border{border-width:1px}.border-t{border-top-width:1px}.block{display:block}.inline{display:inline}.flex{display:flex}.table{display:table}.hidden{display:none}.flex-row{flex-direction:row}.flex-col{flex-direction:column}.flex-wrap{flex-wrap:wrap}.items-center{align-items:center}.justify-center{justify-content:center}.font-bold{font-weight:700}.h-screen{height:100vh}.text-3xl{font-size:1.875rem}.leading-6{line-height:1.5rem}.leading-8{line-height:2rem}.mb-4{margin-bottom:1rem}.mr-8{margin-right:2rem}.mb-12{margin-bottom:3rem}.mt-32{margin-top:8rem}.max-w-none{max-width:none}.max-w-4xl{max-width:56rem}.overflow-hidden{overflow:hidden}.p-0{padding:0}.p-8{padding:2rem}.pb-6{padding-bottom:1.5rem}.pr-8{padding-right:2rem}.pt-16{padding-top:4rem}.uppercase{text-transform:uppercase}.underline{text-decoration:underline}.w-32{width:8rem}.transition{transition-property:background-color,border-color,color,fill,stroke,opacity,box-shadow,transform}@keyframes spin{to{transform:rotate(1turn)}}@keyframes ping{75%,to{transform:scale(2);opacity:0}}@keyframes pulse{50%{opacity:.5}}@keyframes bounce{0%,to{transform:translateY(-25%);animation-timing-function:cubic-bezier(.8,0,1,1)}50%{transform:none;animation-timing-function:cubic-bezier(0,0,.2,1)}}@media (min-width:640px){.sm\:container{width:100%;max-width:640px}@media (min-width:768px){.sm\:container{max-width:768px}}@media (min-width:1024px){.sm\:container{max-width:1024px}}@media (min-width:1280px){.sm\:container{max-width:1280px}}}@media (min-width:768px){.md\:container{width:100%}@media (min-width:640px){.md\:container{max-width:640px}}@media (min-width:768px){.md\:container{max-width:768px}}@media (min-width:1024px){.md\:container{max-width:1024px}}@media (min-width:1280px){.md\:container{max-width:1280px}}.md\:block{display:block}.md\:flex{display:flex}.md\:hidden{display:none}.md\:mb-0{margin-bottom:0}.md\:p-8{padding:2rem}.md\:p-32{padding:8rem}.md\:pt-8{padding-top:2rem}.md\:pb-8{padding-bottom:2rem}.md\:w-48{width:12rem}}@media (min-width:1024px){.lg\:container{width:100%}@media (min-width:640px){.lg\:container{max-width:640px}}@media (min-width:768px){.lg\:container{max-width:768px}}@media (min-width:1024px){.lg\:container{max-width:1024px}}@media (min-width:1280px){.lg\:container{max-width:1280px}}}@media (min-width:1280px){.xl\:container{width:100%}@media (min-width:640px){.xl\:container{max-width:640px}}@media (min-width:768px){.xl\:container{max-width:768px}}@media (min-width:1024px){.xl\:container{max-width:1024px}}@media (min-width:1280px){.xl\:container{max-width:1280px}}}@media (prefers-color-scheme:dark){.dark-mode\:container{width:100%}@media (min-width:640px){.dark-mode\:container{max-width:640px}}@media (min-width:768px){.dark-mode\:container{max-width:768px}}@media (min-width:1024px){.dark-mode\:container{max-width:1024px}}@media (min-width:1280px){.dark-mode\:container{max-width:1280px}}.dark-mode\:text-white{--text-opacity:1;color:#fff;color:rgba(255,255,255,var(--text-opacity))}}</style><meta name="generator" content="Gatsby 2.18.10"/><title data-react-helmet="true">Animating Metal Content with CoreAnimation</title><link data-react-helmet="true" href="https://fonts.googleapis.com/css?family=Roboto:700" rel="stylesheet" type="text/css"/><link data-react-helmet="true" href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,400;1,300&amp;display=swap" rel="stylesheet"/><link data-react-helmet="true" rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.13.0/styles/atom-one-light.min.css"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" name="twitter:creator" content="@noahsark769"/><meta data-react-helmet="true" name="twitter:site" content="@noahsark769"/><meta data-react-helmet="true" property="og:url" content="https://noahgilmore.com/blog/coreanimation-metal/"/><meta data-react-helmet="true" property="og:title" content="Animating Metal Content with CoreAnimation"/><meta data-react-helmet="true" property="og:description" content="Recently, I&#x27;ve been learning more about Metal - I&#x27;m still working through the basics, but I&#x27;ve written a couple of posts and tweets about it, and I&#x27;m about halfway through Metal By Example. Up until now I&#x27;ve mostly been coding sample projects, but I recently had the opportunity to prototype a Metal implementation integrated into our production app at work..."/><meta data-react-helmet="true" name="twitter:description" content="Recently, I&#x27;ve been learning more about Metal - I&#x27;m still working through the basics, but I&#x27;ve written a couple of posts and tweets about it, and I&#x27;m about halfway through Metal By Example. Up until now I&#x27;ve mostly been coding sample projects, but I recently had the opportunity to prototype a Metal implementation integrated into our production app at work..."/><meta data-react-helmet="true" name="description" content="Recently, I&#x27;ve been learning more about Metal - I&#x27;m still working through the basics, but I&#x27;ve written a couple of posts and tweets about it, and I&#x27;m about halfway through Metal By Example. Up until now I&#x27;ve mostly been coding sample projects, but I recently had the opportunity to prototype a Metal implementation integrated into our production app at work..."/><style data-styled="kZJxiO  inkKqg ihgmJg glYDzJ jjWRSm bkeDie hAFKjM jtmfVw gablWf bDzSYv iQPMaQ cMmljL ilthni fiaZzq hrBqpY iKttdc bmzpLX jmGPXo gkfXpi dXIkuv" data-styled-version="4.4.1">
/* sc-component-id: CaptionedImage__Wrap-owr0zk-0 */
.hrBqpY{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;margin:20px 0;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;}
/* sc-component-id: CaptionedImage__Container-owr0zk-1 */
.iKttdc{-webkit-flex:1;-ms-flex:1;flex:1;max-width:400px;}
/* sc-component-id: CaptionedImage__Caption-owr0zk-2 */
.bmzpLX{font-family:"Gentium Book Basic",times,serif;font-style:italic;font-size:16px;color:#999;margin-bottom:30px;margin-top:12px;text-align:center;line-height:1.2em;} .bmzpLX img{width:100%;margin-bottom:10px;}
/* sc-component-id: sc-global-3677396698 */
@font-face{font-family:'Bariol';src:url('/static/Bariol-Regular-b0d07df351f442860551405a4be58de7.eot');src:url('/static/Bariol-Regular-b0d07df351f442860551405a4be58de7.eot?#iefix') format('embedded-opentype'), url('/static/Bariol-Regular-4afd94f0fd93a1f63b46c6c6ad792f71.woff') format('woff'), url('/static/Bariol-Regular-8a7d23d53f8d118e190c63e4e81a91fe.ttf') format('truetype'), url('/static/Bariol-Regular-75b90056f4cdf5a742897ec0a59569d7.svg#svgBariolRegular') format('svg');} *{box-sizing:border-box !important;} body{margin:0;padding:0;} @media (prefers-color-scheme:dark){html,body{background-color:#23282f;}}
/* sc-component-id: default__HighlightedA-phsh4y-6 */
.gkfXpi,.gkfXpi:hover,.gkfXpi:focus{color:#1A3F4B;-webkit-transition:0.2s ease-in-out;-moz-transition:0.2s ease-in-out;-o-transition:0.2s ease-in-out;-webkit-transition:0.2s ease-in-out;transition:0.2s ease-in-out;outline:none;-webkit-text-decoration:underline;text-decoration:underline;} @media (prefers-color-scheme:dark){.gkfXpi,.gkfXpi:hover,.gkfXpi:focus{color:#60b5d1;}}
/* sc-component-id: Nav__StyledNav-sc-17txzo8-0 */
.inkKqg{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;padding:20px 60px;} @media all and (max-width:600px){.inkKqg{padding:20px;}} @media (prefers-color-scheme:dark){.inkKqg{border-color:#777;}}
/* sc-component-id: Nav__Title-sc-17txzo8-1 */
.ihgmJg{-webkit-flex:2;-ms-flex:2;flex:2;font-family:"Roboto","Helvetica Neue","Helvetica",sans-serif;font-size:28px;font-display:swap;} @media (prefers-color-scheme:dark){.ihgmJg{color:#fff;}}
/* sc-component-id: Nav__NavLinks-sc-17txzo8-2 */
.jjWRSm{margin:0;padding:0;-webkit-flex:10;-ms-flex:10;flex:10;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:horizontal;-ms-flex-direction:horizontal;flex-direction:horizontal;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:end;-webkit-justify-content:flex-end;-ms-flex-pack:end;justify-content:flex-end;height:100%;-webkit-align-self:center;-ms-flex-item-align:center;align-self:center;}
/* sc-component-id: Nav__NavLink-sc-17txzo8-3 */
.bkeDie{margin:0;padding:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:vertical;-ms-flex-direction:vertical;flex-direction:vertical;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;text-align:center;font-family:"Roboto","Helvetica Neue","Helvetica",sans-serif;font-size:16px;padding:0px 8px;} @media all and (min-width:370px){.bkeDie{padding:0px 20px;}}
/* sc-component-id: Nav__StyledA-sc-17txzo8-4 */
.glYDzJ{height:auto;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:vertical;-ms-flex-direction:vertical;flex-direction:vertical;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-transition:0.2s ease-in-out;-moz-transition:0.2s ease-in-out;-o-transition:0.2s ease-in-out;-webkit-transition:0.2s ease-in-out;transition:0.2s ease-in-out;} .glYDzJ,.glYDzJ:hover,.glYDzJ:focus{outline:none;color:inherit;-webkit-text-decoration:none;text-decoration:none;}
/* sc-component-id: BlogPost__BlogPostContainer-tv75ut-0 */
.hAFKjM{padding:60px 0;margin:0 auto;width:90%;} @media all and (min-width:600px){.hAFKjM{max-width:700px;margin:auto;}} @media all and (max-width:600px){.hAFKjM{width:100%;padding:20px 0;}}
/* sc-component-id: BlogPost__TitleContainer-tv75ut-1 */
.iQPMaQ{width:100%;margin-bottom:40px;}
/* sc-component-id: BlogPost__Heading-tv75ut-2 */
.cMmljL{width:100%;font-family:"Roboto","Helvetica Neue","Helvetica",sans-serif;font-size:34px;margin-bottom:10px;line-height:1.2em;} @media (prefers-color-scheme:dark){.cMmljL{color:#fff;}}
/* sc-component-id: BlogPost__DateContainer-tv75ut-4 */
.ilthni{font-family:"Merriweather",times,serif;font-style:italic;font-size:13px;color:#999;}
/* sc-component-id: MarkdownContent__Container-gk8834-0 */
.fiaZzq p,.fiaZzq li{margin:0;padding:0;font-family:"Merriweather",times,serif;font-size:18px;line-height:29px;color:#333;padding-bottom:15px;margin-top:15px;} @media all and (max-width:600px){.fiaZzq p,.fiaZzq li{width:90%;margin:15px auto 0 auto;}} @media (prefers-color-scheme:dark){.fiaZzq p,.fiaZzq li{color:#fff;}} .fiaZzq blockquote{background-color:#faf9f7;border-left:4px solid #e5e4e1;padding:20px;font-style:italic;font-synthesis:weight;font-weight:300;} @media (prefers-color-scheme:dark){.fiaZzq blockquote{background-color:#2b2c2f;}} .fiaZzq blockquote p{margin:0;padding:0;color:#555;} @media (prefers-color-scheme:dark){.fiaZzq blockquote p{color:#fff;}} .fiaZzq a{color:#1A3F4B;-webkit-transition:0.2s ease-in-out;-moz-transition:0.2s ease-in-out;-o-transition:0.2s ease-in-out;-webkit-transition:0.2s ease-in-out;transition:0.2s ease-in-out;-webkit-text-decoration:underline;text-decoration:underline;} @media (prefers-color-scheme:dark){.fiaZzq a{color:#60b5d1;}} .fiaZzq a:hover{color:#47656E;} @media (prefers-color-scheme:dark){.fiaZzq a:hover{color:#6bcfef;}} .fiaZzq code{font-family:monospace;font-size:16px;padding:3px 5px;margin:0px 2px;} @media (prefers-color-scheme:dark){.fiaZzq code{color:#fff;}} .fiaZzq code:not(.vscode-highlight-code){font-family:monospace;font-size:16px;background-color:#faf9f7;border:1px solid #e5e4e1;padding:3px 5px;margin:0px 2px;color:#555;} @media (prefers-color-scheme:dark){.fiaZzq code:not(.vscode-highlight-code){color:#fff;background-color:#3f3f3f;}} .fiaZzq code:first-child{margin-left:0;} .fiaZzq pre{display:block;margin:0;padding:0;margin-top:10px;border:1px solid #e5e4e1;border-radius:2px;} @media all and (max-width:600px){.fiaZzq pre{width:100%;margin:10px auto 0 auto;border-left:none;border-right:none;border-radius:0;overflow-x:scroll;}} .fiaZzq pre > code{display:block;margin:0;padding:10px;font-family:monospace;font-size:14px;line-height:17px;white-space:pre-wrap;} @media all and (max-width:600px){.fiaZzq pre > code{font-size:15px;white-space:pre;padding:15px 5% 15px 5%;width:100%;}} .fiaZzq pre + p{margin-top:30px;} .fiaZzq ol{margin-left:30px;} @media all and (max-width:600px){.fiaZzq ol{width:90%;margin:0 auto 0 30px;}} @media (prefers-color-scheme:dark){.fiaZzq ol{color:#fff;}} .fiaZzq ol li{list-style-type:decimal;} .fiaZzq ul li{list-style-type:square;margin-left:40px;} @media all and (max-width:600px){.fiaZzq ul li{width:90%;margin:0 auto;}} @media (prefers-color-scheme:dark){.fiaZzq ul li{color:#fff;}} .fiaZzq h1,.fiaZzq h2,.fiaZzq h3,.fiaZzq h4,.fiaZzq h5,.fiaZzq h6{width:100%;font-family:"Roboto","Helvetica Neue","Helvetica",sans-serif;margin-bottom:10px;margin-top:40px;} @media all and (max-width:600px){.fiaZzq h1,.fiaZzq h2,.fiaZzq h3,.fiaZzq h4,.fiaZzq h5,.fiaZzq h6{width:90%;margin:40px auto 10px auto;}} @media (prefers-color-scheme:dark){.fiaZzq h1,.fiaZzq h2,.fiaZzq h3,.fiaZzq h4,.fiaZzq h5,.fiaZzq h6{color:#fff;}} .fiaZzq h1{font-size:28px;} .fiaZzq h2{font-size:24px;} .fiaZzq h3{font-size:20px;} .fiaZzq em{font-style:italic;} .fiaZzq strong{font-weight:bold;}
/* sc-component-id: EndButtons__Container-sc-1rt8k5q-0 */
.jmGPXo{width:100%;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:horizontal;-ms-flex-direction:horizontal;flex-direction:horizontal;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;margin-top:40px;font-family:"Merriweather",serif;} @media (prefers-color-scheme:dark){.jmGPXo{color:#fff;}}
/* sc-component-id: Disqus__Wrapper-sc-15q2k8t-0 */
.dXIkuv{margin-top:40px;}
/* sc-component-id: BlogPageLayout__Container-sc-1pnb15k-0 */
@media (prefers-color-scheme:dark){.kZJxiO{background-color:#23282f;}}
/* sc-component-id: BlogPageLayout__NonContent-sc-1pnb15k-1 */
@media all and (max-width:600px){.bDzSYv{padding-right:5%;padding-left:5%;}}
/* sc-component-id: BlogPageLayout__PostContainerOuter-sc-1pnb15k-4 */
.jtmfVw{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;padding:0;} @media all and (max-width:1200px){.jtmfVw{padding:0;}}
/* sc-component-id: BlogPageLayout__PostContainerInner-sc-1pnb15k-5 */
.gablWf{display:block;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;width:100%;}</style><style data-styled="fecpOA" data-styled-version="4.4.1">
/* sc-component-id: BlogPageLayout__MyTag-sc-1pnb15k-8 */
.fecpOA{position:relative;} @media all and (min-width:600px){.fecpOA{margin-left:-50px;padding-left:50px;}}</style><link rel="sitemap" type="application/xml" href="/sitemap.xml"/><link rel="alternate" type="application/rss+xml" title="Noah Gilmore&#x27;s Development Blog: Apple Platform Development" href="/blog/apple.xml"/><link rel="alternate" type="application/rss+xml" title="Noah Gilmore&#x27;s Development Blog: iOS" href="/blog/ios.xml"/><link rel="alternate" type="application/rss+xml" title="Noah Gilmore&#x27;s Development Blog: Web" href="/blog/web.xml"/><link rel="alternate" type="application/rss+xml" title="Noah Gilmore&#x27;s Development Blog" href="/blog/rss.xml"/><link as="script" rel="preload" href="/webpack-runtime-ca5d89e5047a55ed27c3.js"/><link as="script" rel="preload" href="/styles-c1c07cf25e5f354e4d8e.js"/><link as="script" rel="preload" href="/app-9ab4ac20c20e3fd76ce9.js"/><link as="script" rel="preload" href="/commons-3e6dfaab6d1d44869a85.js"/><link as="script" rel="preload" href="/component---src-pages-blog-coreanimation-metal-mdx-71ec5a53613965d04cb7.js"/><link as="fetch" rel="preload" href="/page-data/blog/coreanimation-metal/page-data.json" crossorigin="anonymous"/></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" role="group" id="gatsby-focus-wrapper"><div class="BlogPageLayout__Container-sc-1pnb15k-0 kZJxiO"><nav class="Nav__StyledNav-sc-17txzo8-0 inkKqg"><div class="Nav__Title-sc-17txzo8-1 ihgmJg"><a href="/blog" class="default__A-phsh4y-5 Nav__StyledA-sc-17txzo8-4 glYDzJ">NOAH GILMORE</a></div><ul class="default__UL-phsh4y-2 Nav__NavLinks-sc-17txzo8-2 jjWRSm"><li title="Site Home" class="default__LI-phsh4y-3 Nav__NavLink-sc-17txzo8-3 bkeDie"><a aria-label="Home" href="/" class="default__A-phsh4y-5 Nav__StyledA-sc-17txzo8-4 glYDzJ"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" color="rgba(128, 165, 177, 1)" size="24" style="color:rgba(128, 165, 177, 1)" height="24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M258.5 104.1c-1.5-1.2-3.5-1.2-5 0l-156 124.8c-.9.8-1.5 1.9-1.5 3.1v230c0 1.1.9 2 2 2h108c1.1 0 2-.9 2-2V322c0-1.1.9-2 2-2h92c1.1 0 2 .9 2 2v140c0 1.1.9 2 2 2h108c1.1 0 2-.9 2-2V232c0-1.2-.6-2.4-1.5-3.1l-156-124.8z"></path><path d="M458.7 204.2l-189-151.4C265.9 49.7 261 48 256 48s-9.9 1.7-13.7 4.8L160 119.7V77.5c0-1.1-.9-2-2-2H98c-1.1 0-2 .9-2 2v92.2l-42.7 35.1c-3.1 2.5-5.1 6.2-5.3 10.2-.2 4 1.3 7.9 4.1 10.7 2.6 2.6 6.1 4.1 9.9 4.1 3.2 0 6.3-1.1 8.8-3.1l183.9-148c.5-.4.9-.4 1.3-.4s.8.1 1.3.4l183.9 147.4c2.5 2 5.6 3.1 8.8 3.1 3.7 0 7.2-1.4 9.9-4.1 2.9-2.8 4.4-6.7 4.2-10.7-.3-4-2.2-7.7-5.4-10.2z"></path></svg></a></li><li title="Twitter" class="default__LI-phsh4y-3 Nav__NavLink-sc-17txzo8-3 bkeDie"><a aria-label="Twitter" href="https://twitter.com/noahsark769" class="default__A-phsh4y-5 Nav__StyledA-sc-17txzo8-4 glYDzJ"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" color="rgba(128, 165, 177, 1)" size="24" style="color:rgba(128, 165, 177, 1)" height="24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"></path></svg></a></li><li title="GitHub" class="default__LI-phsh4y-3 Nav__NavLink-sc-17txzo8-3 bkeDie hidden md:flex"><a aria-label="GitHub" href="https://github.com/noahsark769" class="default__A-phsh4y-5 Nav__StyledA-sc-17txzo8-4 glYDzJ"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" color="rgba(128, 165, 177, 1)" size="24" style="color:rgba(128, 165, 177, 1)" height="24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M256 32C132.3 32 32 134.9 32 261.7c0 101.5 64.2 187.5 153.2 217.9 1.4.3 2.6.4 3.8.4 8.3 0 11.5-6.1 11.5-11.4 0-5.5-.2-19.9-.3-39.1-8.4 1.9-15.9 2.7-22.6 2.7-43.1 0-52.9-33.5-52.9-33.5-10.2-26.5-24.9-33.6-24.9-33.6-19.5-13.7-.1-14.1 1.4-14.1h.1c22.5 2 34.3 23.8 34.3 23.8 11.2 19.6 26.2 25.1 39.6 25.1 10.5 0 20-3.4 25.6-6 2-14.8 7.8-24.9 14.2-30.7-49.7-5.8-102-25.5-102-113.5 0-25.1 8.7-45.6 23-61.6-2.3-5.8-10-29.2 2.2-60.8 0 0 1.6-.5 5-.5 8.1 0 26.4 3.1 56.6 24.1 17.9-5.1 37-7.6 56.1-7.7 19 .1 38.2 2.6 56.1 7.7 30.2-21 48.5-24.1 56.6-24.1 3.4 0 5 .5 5 .5 12.2 31.6 4.5 55 2.2 60.8 14.3 16.1 23 36.6 23 61.6 0 88.2-52.4 107.6-102.3 113.3 8 7.1 15.2 21.1 15.2 42.5 0 30.7-.3 55.5-.3 63 0 5.4 3.1 11.5 11.4 11.5 1.2 0 2.6-.1 4-.4C415.9 449.2 480 363.1 480 261.7 480 134.9 379.7 32 256 32z"></path></svg></a></li><li title="App Store" class="default__LI-phsh4y-3 Nav__NavLink-sc-17txzo8-3 bkeDie"><a aria-label="App Store" href="https://apps.apple.com/us/app/cifilter-io/id1457458557" class="default__A-phsh4y-5 Nav__StyledA-sc-17txzo8-4 glYDzJ"><svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 512 512" color="rgba(128, 165, 177, 1)" size="24" style="color:rgba(128, 165, 177, 1)" height="24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M256 48C141.1 48 48 141.1 48 256s93.1 208 208 208 208-93.1 208-208S370.9 48 256 48zm-78.9 296.9c-2.7 4.6-7.5 7.1-12.5 7.1-2.5 0-5-.6-7.3-2-6.9-4-9.2-12.8-5.2-19.7l14.2-23.6c1.5-2.5 4.1-4 7-4h2.1c10.3 0 17.5 6.2 19.6 12.2l-17.9 30zm120.2-46.4l-93 .1h-61.8c-8.2 0-14.8-6.8-14.4-15 .3-7.8 7.1-13.7 14.9-13.7h44.8l53.1-90.4-17.2-29.3c-3.9-6.7-2.2-15.5 4.4-19.7 7-4.5 16.2-2.2 20.3 4.8l9.2 15.7h.1l9.2-15.7c4.1-7 13.4-9.3 20.3-4.8 6.6 4.2 8.3 13 4.4 19.7l-17.2 29.3-16.7 28.5-36.3 61.9v.1h53.5c6.7 0 15.1 3.6 18.5 9.4l.3.6c3 5.1 4.7 8.6 4.7 13.7-.1 2.8-1.1 4.8-1.1 4.8zm72.2.1h-25.2v.1l18.4 31.3c4 6.8 2.1 15.8-4.8 20-2.3 1.4-4.9 2.1-7.5 2.1-5 0-9.8-2.6-12.5-7.1l-27.2-46.3-16.9-28.8-21.8-37.3c-6.4-10.9-6.7-24.5-.6-35.3 4.3-7.6 7.6-9.6 7.6-9.6l48.5 82.1h41.7c7.8 0 14.5 6 14.9 13.7.3 8.3-6.3 15.1-14.6 15.1z"></path></svg></a></li></ul></nav><div class="BlogPost__BlogPostContainer-tv75ut-0 hAFKjM"><div class="BlogPageLayout__PostContainerOuter-sc-1pnb15k-4 jtmfVw"><div class="BlogPageLayout__PostContainerInner-sc-1pnb15k-5 gablWf"><div class="BlogPageLayout__NonContent-sc-1pnb15k-1 bDzSYv"><div><div class="BlogPost__TitleContainer-tv75ut-1 iQPMaQ"><h1 class="BlogPost__Heading-tv75ut-2 cMmljL">Animating Metal Content with CoreAnimation</h1><p class="BlogPost__DateContainer-tv75ut-4 ilthni">December 10, 2019</p></div></div></div><div class="MarkdownContent__Container-gk8834-0 fiaZzq"><blockquote><p>Update (12/26/2019): A previous version of this post incorrectly stated implict animations happen in layers which back <code>UIView</code>s. Actually, layers which back <code>UIView</code>s don&#x27;t have animations unless you implement the view&#x27;s <code>action(for:forKey:)</code> method. More information is available in <a href="https://github.com/noahsark769/NGUIViewLayerBackgroundColorTest">this github repo</a>.</p></blockquote><p>Recently, I&#x27;ve been learning more about Metal - I&#x27;m still working through the basics, but I&#x27;ve written a couple of <a href="/blog/gpu-capture-flickering">posts</a> and <a href="https://twitter.com/noahsark769/status/1197599674917515264">tweets</a> about it, and I&#x27;m about halfway through <a href="https://github.com/noahsark769/MetalByExampleExamples">Metal By Example</a>. Up until now I&#x27;ve mostly been coding sample projects, but I recently had the opportunity to prototype a Metal implementation integrated into our production app at work.</p><p>One thing I hadn&#x27;t considered until I had to implement Metal in a real app was animations - when another part of our interface animated, we wanted to scale the Metal content along with an animation. This post will dive into how to adapt the CALayer animation system to work with a custom Metal view, and along the way we&#x27;ll see a situation which Swift can&#x27;t handle without hacks. (😱)</p><p>Our goal will be to build a triangle that animates to a new scale when a button is pressed:</p><div class="CaptionedImage__Wrap-owr0zk-0 hrBqpY"><div max="400" class="CaptionedImage__Container-owr0zk-1 iKttdc"><img style="width:100%" alt="Blue triangle animating from 1x to 2x scale when a button is clicked" src="/static/calayer-metal-1-f70e3fad0f6e47a2b713325ea69e6465.gif"/><div class="CaptionedImage__Caption-owr0zk-2 bmzpLX"></div></div></div><blockquote><p>Full sample code is available for this project at <a href="https://github.com/noahsark769/NGCAMetalLayerAnimationExample">NGCAMetalLayerAnimationExample</a>.</p></blockquote><h2 id="getting-started" class="BlogPageLayout__MyTag-sc-1pnb15k-8 fecpOA">Getting started</h2><p>Our sample project will follow the architecture adapted from the Xcode default Metal project (what Xcode gives you after New Project &gt; Cross Platform Game):</p><ol><li>We&#x27;ll have a <code>Renderer</code> with a <code>draw(drawable:)</code> method which is responsible for issuing Metal draw calls with the <code>drawable</code> as a target. The renderer will have a <code>triangleScale</code> property to determine what transform to the triangle&#x27;s vertices.</li><li>We&#x27;ll have a custom view with a <a href="https://developer.apple.com/documentation/quartzcore/cametallayer"><code>CAMetalLayer</code></a> subclass, and we&#x27;ll override the layer&#x27;s <code>display()</code> to call <code>draw</code>, passing the drawable from <a href="https://developer.apple.com/documentation/quartzcore/cametallayer/1478172-nextdrawable"><code>nextDrawable</code></a>.</li></ol><blockquote><p>Note: we need a <code>CAMetalLayer</code> instead of an <a href="https://developer.apple.com/documentation/metalkit/mtkview"><code>MTKView</code></a> here, for reasons I&#x27;ll get into near the end of this post.</p></blockquote><p>Our custom layer looks like this:</p><pre class="dark-default-dark vscode-highlight" data-language="swift"><code class="vscode-highlight-code"><span class="vscode-highlight-line"><span class="mtk4">class</span><span class="mtk1"> </span><span class="mtk10">CustomCAMetalLayer</span><span class="mtk1">: CAMetalLayer {</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    </span><span class="mtk4">private</span><span class="mtk1"> </span><span class="mtk4">var</span><span class="mtk1"> renderer: Renderer!</span></span>
<span class="vscode-highlight-line"><span class="mtk1"></span></span>
<span class="vscode-highlight-line"><span class="mtk1">    </span><span class="mtk4">override</span><span class="mtk1"> </span><span class="mtk4">init</span><span class="mtk1">() {</span></span>
<span class="vscode-highlight-line"><span class="mtk1">        </span><span class="mtk4">super</span><span class="mtk1">.</span><span class="mtk4">init</span><span class="mtk1">()</span></span>
<span class="vscode-highlight-line"><span class="mtk1">        </span><span class="mtk4">self</span><span class="mtk1">.</span><span class="mtk12">device</span><span class="mtk1"> = </span><span class="mtk11">MTLCreateSystemDefaultDevice</span><span class="mtk1">()!</span></span>
<span class="vscode-highlight-line"><span class="mtk1">        </span><span class="mtk4">self</span><span class="mtk1">.</span><span class="mtk12">renderer</span><span class="mtk1"> = </span><span class="mtk11">Renderer</span><span class="mtk1">(</span><span class="mtk11">device</span><span class="mtk1">: </span><span class="mtk4">self</span><span class="mtk1">.</span><span class="mtk12">device</span><span class="mtk1">!)</span></span>
<span class="vscode-highlight-line"><span class="mtk1">        </span><span class="mtk4">self</span><span class="mtk1">.</span><span class="mtk11">setNeedsDisplay</span><span class="mtk1">()</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    }</span></span>
<span class="vscode-highlight-line"><span class="mtk1"></span></span>
<span class="vscode-highlight-line"><span class="mtk1">    </span><span class="mtk3">/// Block the current thread until this layer has a drawable ready.</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    </span><span class="mtk4">private</span><span class="mtk1"> </span><span class="mtk4">func</span><span class="mtk1"> </span><span class="mtk11">blockRequestingNextDrawable</span><span class="mtk1">() -&gt; CAMetalDrawable {</span></span>
<span class="vscode-highlight-line"><span class="mtk1">        </span><span class="mtk4">var</span><span class="mtk1"> drawable: CAMetalDrawable? = </span><span class="mtk4">nil</span></span>
<span class="vscode-highlight-line"><span class="mtk1">        </span><span class="mtk15">while</span><span class="mtk1"> (drawable == </span><span class="mtk4">nil</span><span class="mtk1">) {</span></span>
<span class="vscode-highlight-line"><span class="mtk1">            drawable = </span><span class="mtk4">self</span><span class="mtk1">.</span><span class="mtk11">nextDrawable</span><span class="mtk1">()</span></span>
<span class="vscode-highlight-line"><span class="mtk1">        }</span></span>
<span class="vscode-highlight-line"><span class="mtk1">        </span><span class="mtk15">return</span><span class="mtk1"> drawable!</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    }</span></span>
<span class="vscode-highlight-line"><span class="mtk1"></span></span>
<span class="vscode-highlight-line"><span class="mtk1">    </span><span class="mtk4">override</span><span class="mtk1"> </span><span class="mtk4">func</span><span class="mtk1"> </span><span class="mtk11">display</span><span class="mtk1">() {</span></span>
<span class="vscode-highlight-line"><span class="mtk1">        </span><span class="mtk4">let</span><span class="mtk1"> drawable = </span><span class="mtk4">self</span><span class="mtk1">.</span><span class="mtk11">blockRequestingNextDrawable</span><span class="mtk1">()</span></span>
<span class="vscode-highlight-line"><span class="mtk1">        </span><span class="mtk4">self</span><span class="mtk1">.</span><span class="mtk12">renderer</span><span class="mtk1">.</span><span class="mtk11">draw</span><span class="mtk1">(</span><span class="mtk11">drawable</span><span class="mtk1">: drawable)</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    }</span></span>
<span class="vscode-highlight-line"><span class="mtk1">}</span></span>
<span class="vscode-highlight-line"><span class="mtk1"></span></span>
<span class="vscode-highlight-line"><span class="mtk4">class</span><span class="mtk1"> </span><span class="mtk10">MetalView</span><span class="mtk1">: UIView {</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    </span><span class="mtk4">override</span><span class="mtk1"> </span><span class="mtk4">class</span><span class="mtk1"> </span><span class="mtk4">var</span><span class="mtk1"> layerClass: </span><span class="mtk10">AnyClass</span><span class="mtk1"> {</span></span>
<span class="vscode-highlight-line"><span class="mtk1">        </span><span class="mtk15">return</span><span class="mtk1"> CustomCAMetalLayer.self</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    }</span></span>
<span class="vscode-highlight-line"><span class="mtk1">}</span></span></code></pre><p>We set up our renderer in init, wait for a drawable to become available, and use our renderer to draw the triangle. The renderer code is more verbose since Metal requires quite a lot of code to set up a command queue, vertex buffers, etc, but you can view the code <a href="https://github.com/noahsark769/NGCAMetalLayerAnimationExample/blob/master/NGCAMetalLayerAnimationExample%20iOS/GameViewController.swift#L29">here</a> if you like - it creates a buffer of three vertices for the points of the triangle, and the fragment shader shades them blue.</p><div class="CaptionedImage__Wrap-owr0zk-0 hrBqpY"><div max="400" class="CaptionedImage__Container-owr0zk-1 iKttdc"><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden"><div style="width:100%;padding-bottom:141.57303370786516%"></div><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAcCAYAAABh2p9gAAAACXBIWXMAABYlAAAWJQFJUiTwAAABoUlEQVRIx+WVOU/DQBCFnQSBQIC4JY4kiEsUXAUVSNAEkJAQf4GSho4CCioK/gktNRVU0FCRUBHRQQ6oQOSwnfdYe53EIZFD1iWWRjO7lj+/t7tja1S5AKLhNKgpw6xcKMjI5Qhdt29rftQhmSTicSKRINJpRaBjzc4NaiWFFWiDWg3oArlD2bLX9V+BrnWuZN/AUqluE9WA1YchoPANtRVmM+DTo5wwTfiyrlnKXp7J/TVQ190HVg1qK3zPgkOiuji1O5KGIZdABWoDMylwqp0c1cCHe0kwDTXrNjD9Rs52gQNiFFsEi0VJcW9Sy0BLYSQA9gqV58f11lsHdpDjAhYJSOt3t5JitGi9BjgmRpMhcFjkzXkw99269V8KybAFbSN7RD47KqukP2DYsT4i6ptr93o2hzYEToiIBimsg+vT4NdnfWs2AYIznRIWDUlYJCh3vk/MnRw6Z9OsdpFn66VerZ0l+zXZMYNOWLWlslvkq0tp3YKS8Fb4IVpvdxWMLZDby+TWUjV2VsCNOfJgD8znUfMb9fh8wfOtZWXmHw76D8G4PY4oFeQjAAAAAElFTkSuQmCC" alt="Blue triangle displaying on the screen" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms"/><noscript><picture><source srcset="/static/5c88e7e0cb8ad904c3f30fda6eb32a6f/59d48/calayer-metal-2.png 150w,
/static/5c88e7e0cb8ad904c3f30fda6eb32a6f/c6a2b/calayer-metal-2.png 300w,
/static/5c88e7e0cb8ad904c3f30fda6eb32a6f/33482/calayer-metal-2.png 534w" sizes="(max-width: 534px) 100vw, 534px" /><img loading="lazy" sizes="(max-width: 534px) 100vw, 534px" srcset="/static/5c88e7e0cb8ad904c3f30fda6eb32a6f/59d48/calayer-metal-2.png 150w,
/static/5c88e7e0cb8ad904c3f30fda6eb32a6f/c6a2b/calayer-metal-2.png 300w,
/static/5c88e7e0cb8ad904c3f30fda6eb32a6f/33482/calayer-metal-2.png 534w" src="/static/5c88e7e0cb8ad904c3f30fda6eb32a6f/33482/calayer-metal-2.png" alt="Blue triangle displaying on the screen" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div><div class="CaptionedImage__Caption-owr0zk-2 bmzpLX">Hello World</div></div></div><h2 id="calayer-animations" class="BlogPageLayout__MyTag-sc-1pnb15k-8 fecpOA">CALayer animations</h2><p>In order to implement our triangle&#x27;s scale-up animation, we need to talk more about CoreAnimation.</p><p><a href="https://developer.apple.com/documentation/quartzcore">CoreAnimation</a> is the framework that powers <code>CALayer</code> (used to implement <code>UIView</code>). Changes in a <code>CALayer</code> (like setting a new position or background color) are initiated by changing the layer&#x27;s properties.</p><p>Many layer properties (you can see a list <a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/CoreAnimation_guide/AnimatableProperties/AnimatableProperties.html#//apple_ref/doc/uid/TP40004514-CH11-SW4">here</a>) are animatable, which means that when they&#x27;re changed, CoreAnimation will interpolate between the old value and the new value to animate the change. If you&#x27;ve ever tried to change the background color of a <code>CALayer</code> directly (using <code>backgroundColor</code>), you might notice that the change isn&#x27;t instant - there&#x27;s a subtle fade. Animatable <code>CALayer</code> properties all have default, &quot;implicit&quot; animations.</p><blockquote><p>Note: layers which back <code>UIView</code>s don&#x27;t have these implicit animations by default since <code>UIView</code>s don&#x27;t provide an action through their layer delegate method. More on this later.</p></blockquote><p>We&#x27;ll add our <code>triangleScale</code> as a custom layer property - we want this property to animate between 1 and 2 to double the size of the triangle.</p><pre class="dark-default-dark vscode-highlight" data-language="swift"><code class="vscode-highlight-code"><span class="vscode-highlight-line"><span class="mtk4">class</span><span class="mtk1"> </span><span class="mtk10">CustomCAMetalLayer</span><span class="mtk1">: CAMetalLayer {</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    </span><span class="mtk3">// ...</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    </span><span class="mtk4">var</span><span class="mtk1"> triangleScale: CGFloat</span></span>
<span class="vscode-highlight-line"><span class="mtk1"></span></span>
<span class="vscode-highlight-line"><span class="mtk1">    </span><span class="mtk4">override</span><span class="mtk1"> </span><span class="mtk4">init</span><span class="mtk1">() {</span></span>
<span class="vscode-highlight-line"><span class="mtk1">        </span><span class="mtk4">self</span><span class="mtk1">.</span><span class="mtk12">triangleScale</span><span class="mtk1"> = </span><span class="mtk7">1</span></span>
<span class="vscode-highlight-line"><span class="mtk1">        </span><span class="mtk3">// ...</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    }</span></span>
<span class="vscode-highlight-line"><span class="mtk1"></span></span>
<span class="vscode-highlight-line"><span class="mtk1">    </span><span class="mtk4">override</span><span class="mtk1"> </span><span class="mtk4">func</span><span class="mtk1"> </span><span class="mtk11">display</span><span class="mtk1">() {</span></span>
<span class="vscode-highlight-line"><span class="mtk1">        </span><span class="mtk4">self</span><span class="mtk1">.</span><span class="mtk12">renderer</span><span class="mtk1">.</span><span class="mtk12">triangleScale</span><span class="mtk1"> = </span><span class="mtk10">Float</span><span class="mtk1">(triangleScale)</span></span>
<span class="vscode-highlight-line"><span class="mtk1">        </span><span class="mtk3">// ...</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    }</span></span>
<span class="vscode-highlight-line"><span class="mtk1">}</span></span></code></pre><p>Our button callback sets the new value:</p><pre class="dark-default-dark vscode-highlight" data-language="swift"><code class="vscode-highlight-code"><span class="vscode-highlight-line"><span class="mtk4">@objc</span><span class="mtk1"> </span><span class="mtk4">private</span><span class="mtk1"> </span><span class="mtk4">func</span><span class="mtk1"> </span><span class="mtk11">didTapButton</span><span class="mtk1">() {</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    layer.</span><span class="mtk12">triangleScale</span><span class="mtk1"> = </span><span class="mtk7">2</span></span>
<span class="vscode-highlight-line"><span class="mtk1">}</span></span></code></pre><p>And when we run the app and click the button, we get...</p><div class="CaptionedImage__Wrap-owr0zk-0 hrBqpY"><div max="400" class="CaptionedImage__Container-owr0zk-1 iKttdc"><img style="width:100%" alt="Blue triangle displaying with cursor clicking button, but nothing happens with the triangle after button click" src="/static/calayer-metal-3-34dd9dc86f8311094fdf24794bfb0be6.gif"/><div class="CaptionedImage__Caption-owr0zk-2 bmzpLX"></div></div></div><p>...nothing!</p><h2 id="customizing-layer-animations" class="BlogPageLayout__MyTag-sc-1pnb15k-8 fecpOA">Customizing layer animations</h2><p>Turns out, custom CALayer properties don&#x27;t come completely for free. I haven&#x27;t been able to find an official Apple reference on this, but there are several articles online about how to implement them - I&#x27;d recommend <a href="https://www.objc.io/issues/12-animations/animating-custom-layer-properties/">this objc.io article</a> and <a href="https://vimeo.com/44986916">this talk from Rob Napier</a>, but I&#x27;ll try to summarize here.</p><p>In order for CoreAnimation to manage our custom layer properties, they have to be Objc <code>@dynamic</code> properties. Declaring an <code>@dynamic</code> property in Objc tells the compiler that the property implementation will be managed dynamically - in this case, since we&#x27;re a subclass of <code>CALayer</code>, CoreAnimation will manage this property for us, and we don&#x27;t have to declare getters or setters, or handle initializing the property. (Learn more about <code>@dynamic</code> in the <a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/ObjectiveC/Chapters/ocProperties.html#//apple_ref/doc/uid/TP30001163-CH17-SW2">Objective-C reference</a>.)</p><p>The dynamic nature of how CALayer handles property animations is why we need to use a <code>CAMetalLayer</code> instead of an <code>MTKView</code> - if we were to declare these properties on a view subclass instead of a layer subclass, they wouldn&#x27;t be automatically handled in the same way.</p><p>There&#x27;s another wrinkle though - Swift doesn&#x27;t support managing dynamic properties in the same way. There&#x27;s a <code>dynamic</code> keyword in Swift, but that specifies that <a href="https://swiftunboxed.com/interop/objc-dynamic/">function calls should use Objc-style dynamic method dispatch</a>, not that property implementations should be managed dynamically.</p><p><code>@dynamic</code> is a mechanism in Objc that just doesn&#x27;t exist in Swift. Luckily, there&#x27;s a way to get around it - <code>@NSManaged</code>.</p><h2 id="dynamic-properties-in-swift" class="BlogPageLayout__MyTag-sc-1pnb15k-8 fecpOA">Dynamic properties in Swift</h2><p>The <code>@NSManaged</code> property modifier is used for Core Data, but its effect is the same as Objc&#x27;s <code>@dynamic</code> - it defers implementation of the property getters and setters. If we declare our layer property as <code>@NSManaged</code>, <code>CALayer</code> will be able to manage its getters and setters! Our new code looks like:</p><pre class="dark-default-dark vscode-highlight" data-language="swift"><code class="vscode-highlight-code"><span class="vscode-highlight-line"><span class="mtk4">class</span><span class="mtk1"> </span><span class="mtk10">CustomCAMetalLayer</span><span class="mtk1">: CAMetalLayer {</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    </span><span class="mtk3">// ...</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    </span><span class="mtk4">@NSManaged</span><span class="mtk1"> </span><span class="mtk4">var</span><span class="mtk1"> triangleScale: CGFloat</span></span>
<span class="vscode-highlight-line"><span class="mtk1"></span></span>
<span class="vscode-highlight-line"><span class="mtk1">    </span><span class="mtk4">override</span><span class="mtk1"> </span><span class="mtk4">init</span><span class="mtk1">() {</span></span>
<span class="vscode-highlight-line"><span class="mtk1">        </span><span class="mtk3">// ...</span></span>
<span class="vscode-highlight-line"><span class="mtk1">        </span><span class="mtk4">self</span><span class="mtk1">.</span><span class="mtk12">triangleScale</span><span class="mtk1"> = </span><span class="mtk7">1</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    }</span></span>
<span class="vscode-highlight-line"><span class="mtk1"></span></span>
<span class="vscode-highlight-line"><span class="mtk1">    </span><span class="mtk4">override</span><span class="mtk1"> </span><span class="mtk4">func</span><span class="mtk1"> </span><span class="mtk11">display</span><span class="mtk1">() {</span></span>
<span class="vscode-highlight-line"><span class="mtk1">        </span><span class="mtk4">self</span><span class="mtk1">.</span><span class="mtk12">renderer</span><span class="mtk1">.</span><span class="mtk12">triangleScale</span><span class="mtk1"> = </span><span class="mtk10">Float</span><span class="mtk1">(triangleScale)</span></span>
<span class="vscode-highlight-line"><span class="mtk1">        </span><span class="mtk3">// ...</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    }</span></span>
<span class="vscode-highlight-line"><span class="mtk1">}</span></span></code></pre><p>Now that we&#x27;ve declared our property dynamically, the last step is to tell CoreAnimation that we want the layer to be redisplayed when the property changes. We do this by overriding <code>needsDisplay(forKey:)</code>.</p><pre class="dark-default-dark vscode-highlight" data-language="swift"><code class="vscode-highlight-code"><span class="vscode-highlight-line"><span class="mtk4">override</span><span class="mtk1"> </span><span class="mtk4">class</span><span class="mtk1"> </span><span class="mtk4">func</span><span class="mtk1"> </span><span class="mtk11">needsDisplay</span><span class="mtk1">(</span><span class="mtk11">forKey</span><span class="mtk1"> </span><span class="mtk12">key</span><span class="mtk1">: </span><span class="mtk10">String</span><span class="mtk1">) -&gt; </span><span class="mtk10">Bool</span><span class="mtk1"> {</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    </span><span class="mtk15">if</span><span class="mtk1"> key == </span><span class="mtk8">&quot;triangleScale&quot;</span><span class="mtk1"> {</span></span>
<span class="vscode-highlight-line"><span class="mtk1">        </span><span class="mtk15">return</span><span class="mtk1"> </span><span class="mtk4">true</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    }</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    </span><span class="mtk15">return</span><span class="mtk1"> </span><span class="mtk4">super</span><span class="mtk1">.</span><span class="mtk11">needsDisplay</span><span class="mtk1">(</span><span class="mtk11">forKey</span><span class="mtk1">: key)</span></span>
<span class="vscode-highlight-line"><span class="mtk1">}</span></span></code></pre><p>We have a triangle that changes scale! The only thing left is to actually implement the animation.</p><div class="CaptionedImage__Wrap-owr0zk-0 hrBqpY"><div max="400" class="CaptionedImage__Container-owr0zk-1 iKttdc"><img style="width:100%" alt="Blue triangle changing scale (not animated) when the button is clicked." src="/static/calayer-metal-4-38af61ea4b48b700fa133b47d20d678c.gif"/><div class="CaptionedImage__Caption-owr0zk-2 bmzpLX"></div></div></div><h2 id="using-presentation-layers" class="BlogPageLayout__MyTag-sc-1pnb15k-8 fecpOA">Using presentation layers</h2><p>In CoreAnimation, each layer is actually composed of a &quot;model&quot; layer, which represents the current set of non-interpolated properties, and a &quot;presentation&quot; layer, which represents the layer&#x27;s current state as it appears on screen. Copies of the model and presentation layers are accessible through <code>CALayer</code>&#x27;s <code>model()</code> and <code>presentation()</code> methods.</p><p>As an example: let&#x27;s say we added an animation for our triangleScale, to take its value from 1 to 2.</p><p>The first thing we have to do is make sure our <code>CALayer</code> subclass knows how to be instantiated as a presentation copy - CoreAnimation will call <code>init(layer:)</code> for this.</p><pre class="dark-default-dark vscode-highlight" data-language="swift"><code class="vscode-highlight-code"><span class="vscode-highlight-line"><span class="mtk4">override</span><span class="mtk1"> </span><span class="mtk4">init</span><span class="mtk1">(</span><span class="mtk11">layer</span><span class="mtk1">: </span><span class="mtk10">Any</span><span class="mtk1">) {</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    </span><span class="mtk4">super</span><span class="mtk1">.</span><span class="mtk4">init</span><span class="mtk1">(</span><span class="mtk11">layer</span><span class="mtk1">: layer)</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    </span><span class="mtk15">guard</span><span class="mtk1"> </span><span class="mtk4">let</span><span class="mtk1"> layer = layer as? CustomCAMetalLayer </span><span class="mtk15">else</span><span class="mtk1"> {</span></span>
<span class="vscode-highlight-line"><span class="mtk1">        </span><span class="mtk15">return</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    }</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    </span><span class="mtk4">self</span><span class="mtk1">.</span><span class="mtk12">renderer</span><span class="mtk1"> = layer.</span><span class="mtk12">renderer</span></span>
<span class="vscode-highlight-line"><span class="mtk1">}</span></span></code></pre><p>Then we add an explicit animation:</p><pre class="dark-default-dark vscode-highlight" data-language="swift"><code class="vscode-highlight-code"><span class="vscode-highlight-line"><span class="mtk4">let</span><span class="mtk1"> animation = </span><span class="mtk11">CABasicAnimation</span><span class="mtk1">()</span></span>
<span class="vscode-highlight-line"><span class="mtk1">animation.</span><span class="mtk12">keyPath</span><span class="mtk1"> = </span><span class="mtk8">&quot;triangleScale&quot;</span></span>
<span class="vscode-highlight-line"><span class="mtk1">animation.</span><span class="mtk12">fromValue</span><span class="mtk1"> = </span><span class="mtk7">1</span></span>
<span class="vscode-highlight-line"><span class="mtk1">animation.</span><span class="mtk12">toValue</span><span class="mtk1"> = </span><span class="mtk7">2</span></span>
<span class="vscode-highlight-line"><span class="mtk1">animation.</span><span class="mtk12">duration</span><span class="mtk1"> = </span><span class="mtk7">0.25</span></span>
<span class="vscode-highlight-line"><span class="mtk4">self</span><span class="mtk1">.</span><span class="mtk12">metalView</span><span class="mtk1">.</span><span class="mtk12">layer</span><span class="mtk1">.</span><span class="mtk11">add</span><span class="mtk1">(animation, </span><span class="mtk11">forKey</span><span class="mtk1">: </span><span class="mtk8">&quot;some-key&quot;</span><span class="mtk1">)</span></span></code></pre><p>And a print in our layer&#x27;s <code>display()</code>:</p><pre class="dark-default-dark vscode-highlight" data-language="swift"><code class="vscode-highlight-code"><span class="vscode-highlight-line"><span class="mtk4">let</span><span class="mtk1"> modelScale = </span><span class="mtk4">self</span><span class="mtk1">.</span><span class="mtk11">model</span><span class="mtk1">().</span><span class="mtk12">triangleScale</span></span>
<span class="vscode-highlight-line"><span class="mtk15">guard</span><span class="mtk1"> </span><span class="mtk4">let</span><span class="mtk1"> presentationScale = </span><span class="mtk4">self</span><span class="mtk1">.</span><span class="mtk11">presentation</span><span class="mtk1">()?.</span><span class="mtk12">triangleScale</span><span class="mtk1"> </span><span class="mtk15">else</span><span class="mtk1"> {</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    </span><span class="mtk15">return</span></span>
<span class="vscode-highlight-line"><span class="mtk1">}</span></span>
<span class="vscode-highlight-line"><span class="mtk11">print</span><span class="mtk1">(</span><span class="mtk8">&quot;model: </span><span class="mtk4">\(</span><span class="mtk1">modelScale</span><span class="mtk4">)</span><span class="mtk8">, presentation: </span><span class="mtk4">\(</span><span class="mtk1">presentationScale</span><span class="mtk4">)</span><span class="mtk8">&quot;</span><span class="mtk1">)</span></span></code></pre><p>We&#x27;ll get the following output:</p><pre class="dark-default-dark vscode-highlight" data-language=""><code class="vscode-highlight-code"><span class="vscode-highlight-line">model: 1.0, presentation: 1.0053806598298252</span>
<span class="vscode-highlight-line">model: 1.0, presentation: 1.1318122893571854</span>
<span class="vscode-highlight-line">model: 1.0, presentation: 1.2192756980657578</span>
<span class="vscode-highlight-line">model: 1.0, presentation: 1.2894128262996674</span>
<span class="vscode-highlight-line">model: 1.0, presentation: 1.363368809223175</span>
<span class="vscode-highlight-line">model: 1.0, presentation: 1.4336175322532654</span>
<span class="vscode-highlight-line">model: 1.0, presentation: 1.5070415139198303</span>
<span class="vscode-highlight-line">model: 1.0, presentation: 1.577137529850006</span>
<span class="vscode-highlight-line">model: 1.0, presentation: 1.649360716342926</span>
<span class="vscode-highlight-line">model: 1.0, presentation: 1.7197566032409668</span>
<span class="vscode-highlight-line">model: 1.0, presentation: 1.7918232679367065</span>
<span class="vscode-highlight-line">model: 1.0, presentation: 1.8647624254226685</span>
<span class="vscode-highlight-line">model: 1.0, presentation: 1.9373475313186646</span>
<span class="vscode-highlight-line">model: 1.0, presentation: 1.0</span>
<span class="vscode-highlight-line">model: 1.0, presentation: 1.0</span></code></pre><p>The model layer never changes, and the presentation layer&#x27;s <code>triangleScale</code> is automatically interpolated from 1 to 2 - but changes back to 1 after the animation ends, since CoreAnimation starts using the model value again when the animation ends. Before we see the triangle growing, we&#x27;ll have to fix this interpolation issue.</p><h2 id="custom-animatable-properties" class="BlogPageLayout__MyTag-sc-1pnb15k-8 fecpOA">Custom animatable properties</h2><p>I noted before that with CoreAnimation, animatable layer properties have default animations that apply when you change the property. We can define our own animation by returning a value from the <code>action(forKey:)</code> class method:</p><pre class="dark-default-dark vscode-highlight" data-language="swift"><code class="vscode-highlight-code"><span class="vscode-highlight-line"><span class="mtk4">override</span><span class="mtk1"> </span><span class="mtk4">func</span><span class="mtk1"> </span><span class="mtk11">action</span><span class="mtk1">(</span><span class="mtk11">forKey</span><span class="mtk1"> </span><span class="mtk12">key</span><span class="mtk1">: </span><span class="mtk10">String</span><span class="mtk1">) -&gt; CAAction? {</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    </span><span class="mtk15">if</span><span class="mtk1"> key == </span><span class="mtk8">&quot;triangleScale&quot;</span><span class="mtk1"> {</span></span>
<span class="vscode-highlight-line"><span class="mtk1">        </span><span class="mtk4">let</span><span class="mtk1"> animation = </span><span class="mtk11">CABasicAnimation</span><span class="mtk1">(</span><span class="mtk11">keyPath</span><span class="mtk1">: key)</span></span>
<span class="vscode-highlight-line"><span class="mtk1">        animation.</span><span class="mtk12">fromValue</span><span class="mtk1"> = </span><span class="mtk4">self</span><span class="mtk1">.</span><span class="mtk11">presentation</span><span class="mtk1">()?.</span><span class="mtk12">triangleScale</span></span>
<span class="vscode-highlight-line"><span class="mtk1">        </span><span class="mtk15">return</span><span class="mtk1"> animation</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    }</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    </span><span class="mtk15">return</span><span class="mtk1"> </span><span class="mtk4">super</span><span class="mtk1">.</span><span class="mtk11">action</span><span class="mtk1">(</span><span class="mtk11">forKey</span><span class="mtk1">: key)</span></span>
<span class="vscode-highlight-line"><span class="mtk1">}       </span></span></code></pre><blockquote><p>Note: specifying the fromValue here is important, but other animation properties (duration, timing function, etc) will be inherited from the current <a href="https://developer.apple.com/documentation/quartzcore/catransaction"><code>CATransaction</code></a>.</p></blockquote><p>If we specify an action, we don&#x27;t need to define an animation anymore - CoreAnimation will automatically add the animation we defined when the layer&#x27;s property changes. Adding the animation is now:</p><pre class="dark-default-dark vscode-highlight" data-language="swift"><code class="vscode-highlight-code"><span class="vscode-highlight-line"><span class="mtk15">guard</span><span class="mtk1"> </span><span class="mtk4">let</span><span class="mtk1"> layer = </span><span class="mtk4">self</span><span class="mtk1">.</span><span class="mtk12">metalView</span><span class="mtk1">.</span><span class="mtk12">layer</span><span class="mtk1"> as? CustomCAMetalLayer </span><span class="mtk15">else</span><span class="mtk1"> {</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    </span><span class="mtk15">return</span></span>
<span class="vscode-highlight-line"><span class="mtk1">}</span></span>
<span class="vscode-highlight-line"><span class="mtk1">layer.</span><span class="mtk12">triangleScale</span><span class="mtk1"> = </span><span class="mtk7">2</span></span></code></pre><p>Our model layer stays at 2 while the presentation layer&#x27;s value is interpolated all the way there.</p><pre class="dark-default-dark vscode-highlight" data-language=""><code class="vscode-highlight-code"><span class="vscode-highlight-line">model: 2.0, presentation: 1.0</span>
<span class="vscode-highlight-line">model: 2.0, presentation: 1.0715526789426804</span>
<span class="vscode-highlight-line">model: 2.0, presentation: 1.1949102729558945</span>
<span class="vscode-highlight-line">model: 2.0, presentation: 1.27173313498497</span>
<span class="vscode-highlight-line">model: 2.0, presentation: 1.3447068929672241</span>
<span class="vscode-highlight-line">model: 2.0, presentation: 1.4154288470745087</span>
<span class="vscode-highlight-line">model: 2.0, presentation: 1.4875067472457886</span>
<span class="vscode-highlight-line">model: 2.0, presentation: 1.5570306777954102</span>
<span class="vscode-highlight-line">model: 2.0, presentation: 1.628233015537262</span>
<span class="vscode-highlight-line">model: 2.0, presentation: 1.7017306685447693</span>
<span class="vscode-highlight-line">model: 2.0, presentation: 1.771639108657837</span>
<span class="vscode-highlight-line">model: 2.0, presentation: 1.8431110382080078</span>
<span class="vscode-highlight-line">model: 2.0, presentation: 1.9160330295562744</span>
<span class="vscode-highlight-line">model: 2.0, presentation: 1.9892664551734924</span>
<span class="vscode-highlight-line">model: 2.0, presentation: 2.0</span></code></pre><h2 id="the-last-step" class="BlogPageLayout__MyTag-sc-1pnb15k-8 fecpOA">The last step</h2><p>We&#x27;ve got our presentation layer set up to interpolate the triangle&#x27;s scale, so the last step is to pass it to the renderer. We&#x27;ll change our layer&#x27;s display function to use the presentation value:</p><pre class="dark-default-dark vscode-highlight" data-language="swift"><code class="vscode-highlight-code"><span class="vscode-highlight-line"><span class="mtk4">override</span><span class="mtk1"> </span><span class="mtk4">func</span><span class="mtk1"> </span><span class="mtk11">display</span><span class="mtk1">() {</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    </span><span class="mtk15">guard</span><span class="mtk1"> </span><span class="mtk4">let</span><span class="mtk1"> effectiveScale = </span><span class="mtk4">self</span><span class="mtk1">.</span><span class="mtk11">presentation</span><span class="mtk1">()?.</span><span class="mtk12">triangleScale</span><span class="mtk1"> </span><span class="mtk15">else</span><span class="mtk1"> {</span></span>
<span class="vscode-highlight-line"><span class="mtk1">        </span><span class="mtk15">return</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    }</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    </span><span class="mtk4">self</span><span class="mtk1">.</span><span class="mtk12">renderer</span><span class="mtk1">.</span><span class="mtk12">triangleScale</span><span class="mtk1"> = </span><span class="mtk10">Float</span><span class="mtk1">(effectiveScale)</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    </span><span class="mtk4">let</span><span class="mtk1"> drawable = </span><span class="mtk4">self</span><span class="mtk1">.</span><span class="mtk11">blockRequestingNextDrawable</span><span class="mtk1">()</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    </span><span class="mtk4">self</span><span class="mtk1">.</span><span class="mtk12">renderer</span><span class="mtk1">.</span><span class="mtk11">draw</span><span class="mtk1">(</span><span class="mtk11">drawable</span><span class="mtk1">: drawable)</span></span>
<span class="vscode-highlight-line"><span class="mtk1">}</span></span></code></pre><p>Specify a few parameters for the animation:</p><pre class="dark-default-dark vscode-highlight" data-language="swift"><code class="vscode-highlight-code"><span class="vscode-highlight-line"><span class="mtk1">CATransaction.</span><span class="mtk11">begin</span><span class="mtk1">()</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    CATransaction.</span><span class="mtk11">setAnimationDuration</span><span class="mtk1">(</span><span class="mtk7">2</span><span class="mtk1">)</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    CATransaction.</span><span class="mtk11">setAnimationTimingFunction</span><span class="mtk1">(.</span><span class="mtk4">init</span><span class="mtk1">(</span><span class="mtk11">name</span><span class="mtk1">: .</span><span class="mtk12">easeInEaseOut</span><span class="mtk1">))</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    layer.</span><span class="mtk12">triangleScale</span><span class="mtk1"> = </span><span class="mtk7">2</span></span>
<span class="vscode-highlight-line"><span class="mtk1">CATransaction.</span><span class="mtk11">commit</span><span class="mtk1">()</span></span></code></pre><p>And tada! 🎉</p><div class="CaptionedImage__Wrap-owr0zk-0 hrBqpY"><div max="400" class="CaptionedImage__Container-owr0zk-1 iKttdc"><img style="width:100%" alt="Blue triangle animating from 1x to 2x scale when the button is clicked" src="/static/calayer-metal-1-f70e3fad0f6e47a2b713325ea69e6465.gif"/><div class="CaptionedImage__Caption-owr0zk-2 bmzpLX"></div></div></div><h2 id="more-complicated-animations" class="BlogPageLayout__MyTag-sc-1pnb15k-8 fecpOA">More complicated animations</h2><p>Using CALayer properties to implement our animations means that we can hook into the entire CoreAnimation ecosystem - our <code>triangleScale</code> is now every bit as animatable as every other <code>CALayer</code> property. One benefit is that we get keyframe animations with no extra work! Let&#x27;s make the triangle jump around a bit:</p><pre class="dark-default-dark vscode-highlight" data-language="swift"><code class="vscode-highlight-code"><span class="vscode-highlight-line"><span class="mtk4">let</span><span class="mtk1"> layer = </span><span class="mtk4">self</span><span class="mtk1">.</span><span class="mtk12">metalView</span><span class="mtk1">.</span><span class="mtk12">layer</span><span class="mtk1"> as! CustomCAMetalLayer</span></span>
<span class="vscode-highlight-line"><span class="mtk4">let</span><span class="mtk1"> animation = </span><span class="mtk11">CAKeyframeAnimation</span><span class="mtk1">()</span></span>
<span class="vscode-highlight-line"><span class="mtk1">animation.</span><span class="mtk12">keyPath</span><span class="mtk1"> = </span><span class="mtk8">&quot;triangleScale&quot;</span></span>
<span class="vscode-highlight-line"><span class="mtk1">animation.</span><span class="mtk12">values</span><span class="mtk1"> = [</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    layer.</span><span class="mtk12">triangleScale</span><span class="mtk1">,</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    </span><span class="mtk7">-1</span><span class="mtk1">,</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    </span><span class="mtk7">2</span><span class="mtk1">,</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    </span><span class="mtk7">-2</span><span class="mtk1">,</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    layer.</span><span class="mtk12">triangleScale</span></span>
<span class="vscode-highlight-line"><span class="mtk1">]</span></span>
<span class="vscode-highlight-line"><span class="mtk1">animation.</span><span class="mtk12">keyTimes</span><span class="mtk1"> = [</span><span class="mtk7">0</span><span class="mtk1">, </span><span class="mtk7">0.2</span><span class="mtk1">, </span><span class="mtk7">0.5</span><span class="mtk1">, </span><span class="mtk7">0.8</span><span class="mtk1">, </span><span class="mtk7">1</span><span class="mtk1">]</span></span>
<span class="vscode-highlight-line"><span class="mtk1">animation.</span><span class="mtk12">timingFunctions</span><span class="mtk1"> = [</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    .</span><span class="mtk4">init</span><span class="mtk1">(</span><span class="mtk11">name</span><span class="mtk1">: .</span><span class="mtk12">easeInEaseOut</span><span class="mtk1">),</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    .</span><span class="mtk4">init</span><span class="mtk1">(</span><span class="mtk11">name</span><span class="mtk1">: .</span><span class="mtk12">easeInEaseOut</span><span class="mtk1">),</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    .</span><span class="mtk4">init</span><span class="mtk1">(</span><span class="mtk11">name</span><span class="mtk1">: .</span><span class="mtk12">easeInEaseOut</span><span class="mtk1">),</span></span>
<span class="vscode-highlight-line"><span class="mtk1">    .</span><span class="mtk4">init</span><span class="mtk1">(</span><span class="mtk11">name</span><span class="mtk1">: .</span><span class="mtk12">easeInEaseOut</span><span class="mtk1">)</span></span>
<span class="vscode-highlight-line"><span class="mtk1">]</span></span>
<span class="vscode-highlight-line"><span class="mtk1">animation.</span><span class="mtk12">duration</span><span class="mtk1"> = </span><span class="mtk7">8</span></span>
<span class="vscode-highlight-line"><span class="mtk4">self</span><span class="mtk1">.</span><span class="mtk12">metalView</span><span class="mtk1">.</span><span class="mtk12">layer</span><span class="mtk1">.</span><span class="mtk11">add</span><span class="mtk1">(animation, </span><span class="mtk11">forKey</span><span class="mtk1">: </span><span class="mtk8">&quot;expandScale&quot;</span><span class="mtk1">)</span></span></code></pre><div class="CaptionedImage__Wrap-owr0zk-0 hrBqpY"><div max="400" class="CaptionedImage__Container-owr0zk-1 iKttdc"><img style="width:100%" alt="Blue triangle animating between multiple different scales with a keyframe animation" src="/static/calayer-metal-5-c5b621a9ec31ac8b22136e7ee233a32b.gif"/><div class="CaptionedImage__Caption-owr0zk-2 bmzpLX"></div></div></div><h2 id="conclusion-and-further-reading" class="BlogPageLayout__MyTag-sc-1pnb15k-8 fecpOA">Conclusion and further reading</h2><p>CoreAnimation was always one of the more confusing parts of iOS development to me, but hopefully this post has helped to pull back the covers a bit on how the system works - going through these examples has certainly helped me understand how to make Metal play nicely with other parts of the iOS ecosystem.</p><p>There&#x27;s a lot of great Apple and non-Apple content written about custom CALayer animations <em>not</em> related to Metal that I&#x27;d recommend checking out:</p><ul><li><a href="https://www.objc.io/issues/12-animations/animating-custom-layer-properties/">Animating Custom Layer Properties</a></li><li><a href="https://vimeo.com/44986916">Cocoaheads June 2012: Animating Custom Layer Properties</a></li><li><a href="https://academy.realm.io/posts/tryswift-tim-oliver-advanced-graphics-with-core-animation/">Advanced Graphics with CoreAnimation</a></li><li><a href="https://nsscreencast.com/episodes/290-core-graphics-custom-calayer">Custom CALayer</a></li><li><a href="https://developer.apple.com/library/archive/documentation/Cocoa/Conceptual/CoreAnimation_guide/AdvancedAnimationTricks/AdvancedAnimationTricks.html">Advanced Animation Tricks</a></li></ul><style class="vscode-highlight-styles">
  
  .dark-default-dark {
background-color: #1E1E1E;
color: #D4D4D4;
}

.dark-default-dark .mtk1 { color: #D4D4D4; }
.dark-default-dark .mtk2 { color: #1E1E1E; }
.dark-default-dark .mtk3 { color: #6A9955; }
.dark-default-dark .mtk4 { color: #569CD6; }
.dark-default-dark .mtk5 { color: #D16969; }
.dark-default-dark .mtk6 { color: #D7BA7D; }
.dark-default-dark .mtk7 { color: #B5CEA8; }
.dark-default-dark .mtk8 { color: #CE9178; }
.dark-default-dark .mtk9 { color: #646695; }
.dark-default-dark .mtk10 { color: #4EC9B0; }
.dark-default-dark .mtk11 { color: #DCDCAA; }
.dark-default-dark .mtk12 { color: #9CDCFE; }
.dark-default-dark .mtk13 { color: #000080; }
.dark-default-dark .mtk14 { color: #F44747; }
.dark-default-dark .mtk15 { color: #C586C0; }
.dark-default-dark .mtk16 { color: #6796E6; }
.dark-default-dark .mtk17 { color: #808080; }
.dark-default-dark .mtki { font-style: italic; }
.dark-default-dark .mtkb { font-weight: bold; }
.dark-default-dark .mtku { text-decoration: underline; text-underline-position: under; }
</style></div><div class="BlogPageLayout__NonContent-sc-1pnb15k-1 bDzSYv"><div class="EndButtons__Container-sc-1rt8k5q-0 jmGPXo"><a href="https://twitter.com/intent/tweet?text=Post%20by%20%40noahsark769%3A%20Animating%20Metal%20Content%20with%20CoreAnimation%20https%3A%2F%2Fnoahgilmore.com%2Fblog%2Fcoreanimation-metal%2F" target="_blank" class="default__HighlightedA-phsh4y-6 gkfXpi pr-8">Tweet This</a><a href="https://noahgilmore.substack.com/" target="_blank" class="default__HighlightedA-phsh4y-6 gkfXpi">Get New Posts Via Email</a></div><div style="font-family:&#x27;Merriweather&#x27;, times, serif" class="dark-mode:text-white flex flex-col leading-6 mt-32 pt-16 border-t border-solid border-white"><div class="flex flex-row items-center mb-12 md:mb-0"><div class="w-32 md:w-48 max-w-none rounded-full overflow-hidden mr-8"><div class=" gatsby-image-wrapper" style="position:relative;overflow:hidden"><div style="width:100%;padding-bottom:100%"></div><img src="data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAUABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAQCAQP/xAAUAQEAAAAAAAAAAAAAAAAAAAAB/9oADAMBAAIQAxAAAAGqHuxgbBQF8Qn/xAAeEAABAwQDAAAAAAAAAAAAAAACAAEDBBESEyExMv/aAAgBAQABBQKQXR8BssoDnkR4p8b0XkBY6huv/8QAFREBAQAAAAAAAAAAAAAAAAAAASD/2gAIAQMBAT8BCP/EABYRAQEBAAAAAAAAAAAAAAAAABABQf/aAAgBAgEBPwGmn//EAB0QAAIBBAMAAAAAAAAAAAAAAAABMQIDESEQUXH/2gAIAQEABj8C6NzxWm9YFQ9sgueGHBCP/8QAHBABAAICAwEAAAAAAAAAAAAAAQARITFBYXGB/9oACAEBAAE/IUND6qPHO2JMoYBbNRDz3OII2/mkpnotfI6JZ6T/2gAMAwEAAgADAAAAEBM4gP/EABcRAQADAAAAAAAAAAAAAAAAABABEUH/2gAIAQMBAT8Qsgw//8QAGhEAAgIDAAAAAAAAAAAAAAAAAAEQESFBcf/aAAgBAgEBPxBqaMG3I//EAB4QAQEAAgICAwAAAAAAAAAAAAERACFBUTFhcZGx/9oACAEBAAE/EHFVvJ+4mjaBRl9zDViecIpgCUrx3ocTbhJsBbvvr4x10eIY5LdFeNuLr04Kb2v3gJREorn/2Q==" alt="Picture of me with a corgi" style="position:absolute;top:0;left:0;width:100%;height:100%;object-fit:cover;object-position:center;opacity:1;transition-delay:500ms"/><noscript><picture><source srcset="/static/a5f1e0ee8af819520ac472cb18032c72/421ae/corgi.jpg 150w,
/static/a5f1e0ee8af819520ac472cb18032c72/58d6d/corgi.jpg 300w,
/static/a5f1e0ee8af819520ac472cb18032c72/f5db2/corgi.jpg 600w,
/static/a5f1e0ee8af819520ac472cb18032c72/4d2f6/corgi.jpg 900w,
/static/a5f1e0ee8af819520ac472cb18032c72/04d73/corgi.jpg 1067w" sizes="(max-width: 600px) 100vw, 600px" /><img loading="lazy" sizes="(max-width: 600px) 100vw, 600px" srcset="/static/a5f1e0ee8af819520ac472cb18032c72/421ae/corgi.jpg 150w,
/static/a5f1e0ee8af819520ac472cb18032c72/58d6d/corgi.jpg 300w,
/static/a5f1e0ee8af819520ac472cb18032c72/f5db2/corgi.jpg 600w,
/static/a5f1e0ee8af819520ac472cb18032c72/4d2f6/corgi.jpg 900w,
/static/a5f1e0ee8af819520ac472cb18032c72/04d73/corgi.jpg 1067w" src="/static/a5f1e0ee8af819520ac472cb18032c72/f5db2/corgi.jpg" alt="Picture of me with a corgi" style="position:absolute;top:0;left:0;opacity:1;width:100%;height:100%;object-fit:cover;object-position:center"/></picture></noscript></div></div><div class="flex flex-col"><h1 class="uppercase text-3xl font-bold mb-4 leading-8" style="font-family:&#x27;Roboto&#x27;, sans-serif">Noah Gilmore</h1><p class="hidden md:block">I&#x27;m Noah, a software developer based in the San Francisco Bay Area. I focus mainly on iOS, Apple platform development, and full stack web development.</p></div></div><p class="block md:hidden mb-12">Hello! I&#x27;m Noah, a software developer based in the San Francisco bay area. I focus mainly on iOS, Apple platform development, and full stack web development.</p><div><ul class="p-0 md:pt-8 md:pb-8"><li class="pb-6"><span role="img" aria-label="Computer">💻</span> I&#x27;m writing a macOS editor for Atlassian Confluence called <a class="default__HighlightedA-phsh4y-6 gkfXpi underline" href="https://getfluency.io">Fluency</a></li><li class="pb-6"><span role="img" aria-label="Phone">📱</span> I wrote an app which lets you create transparent app icons called <a class="default__HighlightedA-phsh4y-6 gkfXpi underline" href="https://transparenticons.app">Transparent App Icons</a></li><li class="pb-6"><span role="img" aria-label="Puzzle">🧩</span> I made a puzzle game for iPhone and iPad called <a class="default__HighlightedA-phsh4y-6 gkfXpi underline" href="https://apps.apple.com/us/app/trestle-the-new-sudoku/id1300230302">Trestle</a></li><li class="pb-6"><span role="img" aria-label="Art">🎨</span> I wrote a CoreImage filter utility app for iOS developers called <a class="default__HighlightedA-phsh4y-6 gkfXpi underline" href="https://apps.apple.com/us/app/cifilter-io/id1457458557">CIFilter.io</a></li><li><span role="img" aria-label="Wave">👋</span> Please feel free to reach out on <a class="default__HighlightedA-phsh4y-6 gkfXpi underline" href="https://twitter.com/noahsark769">Twitter</a></li></ul></div></div><div class="Disqus__Wrapper-sc-15q2k8t-0 dXIkuv"><div id="disqus_thread"></div></div></div></div></div></div></div></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/blog/coreanimation-metal/";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"app":["/app-9ab4ac20c20e3fd76ce9.js"],"component---src-templates-mdx-blog-posts-template-jsx":["/component---src-templates-mdx-blog-posts-template-jsx-e7eecaf3819407a43e71.js"],"component---src-pages-404-jsx":["/component---src-pages-404-jsx-4a15296be80b713f3a9d.js"],"component---src-pages-blog-index-jsx":["/component---src-pages-blog-index-jsx-1993272147cdabff5096.js"],"component---src-pages-examples-ios-copy-to-clipboard-index-jsx":["/component---src-pages-examples-ios-copy-to-clipboard-index-jsx-dffdc1859cfeb5df06dd.js"],"component---src-pages-index-jsx":["/component---src-pages-index-jsx-fb6a0d875aa7f0bd0051.js"],"component---src-pages-blog-advertising-mdx":["/component---src-pages-blog-advertising-mdx-6041348659d9ad4498a7.js"],"component---src-pages-blog-amplitude-macos-mdx":["/component---src-pages-blog-amplitude-macos-mdx-6bb9459a62344934ce8a.js"],"component---src-pages-blog-automatic-preview-updating-paused-mdx":["/component---src-pages-blog-automatic-preview-updating-paused-mdx-d1615e4f90af4eb46d49.js"],"component---src-pages-blog-catalina-importerror-no-module-named-zlib-mdx":["/component---src-pages-blog-catalina-importerror-no-module-named-zlib-mdx-a532dcf39d7fef818c33.js"],"component---src-pages-blog-cfbundleversion-invalid-mdx":["/component---src-pages-blog-cfbundleversion-invalid-mdx-c3571ac20ee0da7d4032.js"],"component---src-pages-blog-cifilter-colorwheel-mdx":["/component---src-pages-blog-cifilter-colorwheel-mdx-1264d2ff668442a56743.js"],"component---src-pages-blog-cifilterio-mdx":["/component---src-pages-blog-cifilterio-mdx-09ef1f8ab365e2c0ffed.js"],"component---src-pages-blog-civector-codable-mdx":["/component---src-pages-blog-civector-codable-mdx-a604974277ebf64c5a4c.js"],"component---src-pages-blog-color-compatibility-pod-mdx":["/component---src-pages-blog-color-compatibility-pod-mdx-04b6318ab9152fe8b50c.js"],"component---src-pages-blog-coreanimation-metal-mdx":["/component---src-pages-blog-coreanimation-metal-mdx-71ec5a53613965d04cb7.js"],"component---src-pages-blog-dark-mode-uicolor-compatibility-mdx":["/component---src-pages-blog-dark-mode-uicolor-compatibility-mdx-b42baaee5524ab362631.js"],"component---src-pages-blog-data-over-the-app-store-mdx":["/component---src-pages-blog-data-over-the-app-store-mdx-c0ca5251de352655e4d1.js"],"component---src-pages-blog-didprocessediting-crash-mdx":["/component---src-pages-blog-didprocessediting-crash-mdx-56d5ea29af9b22dfb185.js"],"component---src-pages-blog-docker-commands-mdx":["/component---src-pages-blog-docker-commands-mdx-7a10f712c96ce51a9390.js"],"component---src-pages-blog-easy-gatsby-image-components-mdx":["/component---src-pages-blog-easy-gatsby-image-components-mdx-6bb08b248064874ab7bb.js"],"component---src-pages-blog-gatsby-mdx-frontmatter-mdx":["/component---src-pages-blog-gatsby-mdx-frontmatter-mdx-e7f2795b9aec8d5427aa.js"],"component---src-pages-blog-gatsby-tailwind-mdx":["/component---src-pages-blog-gatsby-tailwind-mdx-4139cd11d9cade837913.js"],"component---src-pages-blog-gpu-capture-flickering-mdx":["/component---src-pages-blog-gpu-capture-flickering-mdx-2fc5a60d32baf22b1ec7.js"],"component---src-pages-blog-install-nokogiri-macos-mojave-mdx":["/component---src-pages-blog-install-nokogiri-macos-mojave-mdx-ac0be3cc0cfaaa31c1cb.js"],"component---src-pages-blog-installing-sharp-github-actions-mdx":["/component---src-pages-blog-installing-sharp-github-actions-mdx-cf5b2e1f9534a3cf52d9.js"],"component---src-pages-blog-my-bucket-list-mdx":["/component---src-pages-blog-my-bucket-list-mdx-03fa7b709932b453003a.js"],"component---src-pages-blog-nesting-property-wrappers-mdx":["/component---src-pages-blog-nesting-property-wrappers-mdx-889dadc41c73688faeac.js"],"component---src-pages-blog-nsobject-equatable-mdx":["/component---src-pages-blog-nsobject-equatable-mdx-4de465e83130b4311a35.js"],"component---src-pages-blog-nstextview-shift-tab-mdx":["/component---src-pages-blog-nstextview-shift-tab-mdx-b2e6f02fcd2a6e4ea1df.js"],"component---src-pages-blog-popover-uinavigationcontroller-preferredcontentsize-mdx":["/component---src-pages-blog-popover-uinavigationcontroller-preferredcontentsize-mdx-db8fdcc313df4336f6a6.js"],"component---src-pages-blog-pyparsing-trees-mdx":["/component---src-pages-blog-pyparsing-trees-mdx-9c3ddd5a1014988f9d49.js"],"component---src-pages-blog-refactoring-private-to-public-mdx":["/component---src-pages-blog-refactoring-private-to-public-mdx-b8df43e3cf2faa93db94.js"],"component---src-pages-blog-rxswift-multiple-subscribers-mdx":["/component---src-pages-blog-rxswift-multiple-subscribers-mdx-5f4ca07e36fa39d6444e.js"],"component---src-pages-blog-sf-symbols-ios-14-mdx":["/component---src-pages-blog-sf-symbols-ios-14-mdx-aa715423efa959eaab5d.js"],"component---src-pages-blog-swift-dependency-injection-mdx":["/component---src-pages-blog-swift-dependency-injection-mdx-d57a10df174cca0c284e.js"],"component---src-pages-blog-swift-pointer-uint-mdx":["/component---src-pages-blog-swift-pointer-uint-mdx-296fdf36620a6897d1f2.js"],"component---src-pages-blog-swiftui-equatable-crash-mdx":["/component---src-pages-blog-swiftui-equatable-crash-mdx-98da1bbe1e2c720583a3.js"],"component---src-pages-blog-swiftui-relativedatetimeformatter-mdx":["/component---src-pages-blog-swiftui-relativedatetimeformatter-mdx-194b1c3fbb0fdd716dfd.js"],"component---src-pages-blog-swiftui-self-sizing-cells-mdx":["/component---src-pages-blog-swiftui-self-sizing-cells-mdx-2ce5a6cdd7aefab53ed0.js"],"component---src-pages-blog-swiftui-two-columns-equal-width-mdx":["/component---src-pages-blog-swiftui-two-columns-equal-width-mdx-6d685eebf7803ec1d8b0.js"],"component---src-pages-blog-tables-are-hard-mdx":["/component---src-pages-blog-tables-are-hard-mdx-1ed388614cc895a99385.js"],"component---src-pages-blog-taking-down-sfsymbols-mdx":["/component---src-pages-blog-taking-down-sfsymbols-mdx-2a3ca080ffbc4aca2886.js"],"component---src-pages-blog-transparent-app-icons-mdx":["/component---src-pages-blog-transparent-app-icons-mdx-938e95c86cd4cd9cac0e.js"],"component---src-pages-blog-tuple-shuffling-mdx":["/component---src-pages-blog-tuple-shuffling-mdx-c16453980be0999333d9.js"],"component---src-pages-blog-uibutton-padding-mdx":["/component---src-pages-blog-uibutton-padding-mdx-ef5ecd02a056dba03341.js"],"component---src-pages-blog-uipasteboard-webp-mdx":["/component---src-pages-blog-uipasteboard-webp-mdx-7169b363512f1290154d.js"],"component---src-pages-blog-uiwindowscene-black-screen-mdx":["/component---src-pages-blog-uiwindowscene-black-screen-mdx-88251d021331b7e5b9a0.js"],"component---src-pages-blog-userdefaults-editor-swiftui-mdx":["/component---src-pages-blog-userdefaults-editor-swiftui-mdx-adca2a971db5f08a7908.js"],"component---src-pages-blog-userdefaults-set-nil-mdx":["/component---src-pages-blog-userdefaults-set-nil-mdx-1024f16a9a2eb83acf13.js"],"component---src-pages-blog-xcode-shared-test-target-mdx":["/component---src-pages-blog-xcode-shared-test-target-mdx-8379ff29794f156fc128.js"]};/*]]>*/</script><script src="/component---src-pages-blog-coreanimation-metal-mdx-71ec5a53613965d04cb7.js" async=""></script><script src="/commons-3e6dfaab6d1d44869a85.js" async=""></script><script src="/app-9ab4ac20c20e3fd76ce9.js" async=""></script><script src="/styles-c1c07cf25e5f354e4d8e.js" async=""></script><script src="/webpack-runtime-ca5d89e5047a55ed27c3.js" async=""></script></body></html>